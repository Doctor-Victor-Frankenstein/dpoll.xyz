{% extends "base.html" %}

{% block content %}

  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <h2>{{ poll.text }}</h2>
        <h6>Asked by <a
            href="http://steemit.com/@{{ poll.username }}/">{{ poll.username }}</a>
        </h6>
        <br/>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 center-block"
      ">
      <div class="user-poll-section">
        <div class="panel panel-default">

          <form method="POST"
                action="{% url 'vote' poll.username poll.permlink %}">
            {% csrf_token %}
            <div class="panel-body">
              {% for choice in choices %}
                <div class="radio">
                  <label>
                    <input type="radio" name="choice-id"
                           id="choice_id_{{ choice.id }}"
                           value="{{ choice.id }}"
                        {% if user_vote.id == choice.id %}
                           checked="true"{% endif %}>
                    <strong> </strong>{{ choice.text }}
                  </label>
                </div>
              {% endfor %}

              <div class="panel-default">
                <button type="submit"
                        class="btn btn-primary"
                        {% if user_vote %}disabled{% endif %}>
                  Vote
                </button>
              </div>
              <hr/>
          </form>

          {% if not total_votes %}
            <em>No votes, yet...</em>
          {% else %}
            {#              {% for choice in choices %}#}
            {#                {{ choice.text }}#}
            {#                <small><em>({{ choice.percent }}%)</em>#}
            {#                  <span class="pull-right"> <a#}
            {#                      data-toggle="modal"#}
            {#                      data-target="#voter-list-{{ choice.id }}">#}
            {#                                         {{ choice.votes }} Voters#}
            {#                                    </a></span>#}
            {#                </small>#}
            {#                <div class="progress progress-striped active">#}
            {#                  <div class="progress-bar progress-bar-success"#}
            {#                       role="progressbar" aria-valuenow="10"#}
            {#                       aria-valuemin="0" aria-valuemax="100"#}
            {#                       style="width: {{ choice.percent }}%">#}
            {#                    <span class="sr-only">{{ choice.percent }}% Complete (success)</span>#}
            {#                  </div>#}
            {#                </div>#}
            {#              {% endfor %}#}
            <div id="canvas-holder" style="width:100%">
              <canvas id="chart-area"></canvas>
            </div>
          {% endif %}
        </div>

      </div>

    </div>
  </div>

  </div>

  </div>

  {% for choice in choices %}
    <div class="modal fade" id="voter-list-{{ choice.id }}" tabindex="-1"
         role="dialog"
         aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"
                    aria-label="Close"><span
                aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Accounts voted
              for '{{ choice.text }}'</h4>
          </div>
          <div class="modal-body">
            <table class="table">
              <thead>
              <tr>
                <th scope="col">Account</th>
              </tr>
              </thead>
              <tbody>
              {% for user in choice.voted_users.all %}
                <tr>
                  <td>@{{ user.username }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default"
                    data-dismiss="modal">Close
            </button>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
{% endblock content %}

{% block extra_js %}
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
  <script>
      var randomScalingFactor = function () {
          return Math.round(Math.random() * 100);
      };

      function getRandomColor() {
          var letters = '0123456789ABCDEF'.split('');
          var color = '#';
          for (var i = 0; i < 6; i++) {
              color += letters[Math.floor(Math.random() * 16)];
          }
          return color;
      }


      var labels = [];
      var colors = [];
      var data = [];
      {% for choice in choices %}
          labels.push("{{ choice.text }}");
          colors.push(getRandomColor());
          data.push({{ choice.votes}});
      {% endfor %}



      var config = {
          type: 'doughnut',
          data: {
              datasets: [{
                  data: data,
                  backgroundColor: colors,
              }],
              labels: labels
          },
          options: {
              responsive: true,
              legend: {
                  position: 'top',
              },
              title: {
                  display: true,
                  text: 'Poll Results'
              },
              animation: {
                  animateScale: true,
                  animateRotate: true
              }
          }
      };


      window.onload = function () {
          var ctx = document.getElementById('chart-area').getContext('2d');
          window.myDoughnut = new Chart(ctx, config);
      };


  </script>

{% endblock %}